<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>北海道 8 天 7 夜旅遊手冊 - 性能優化版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=Montserrat:wght@700;900&display=swap');
        
        :root {
            --hk-sky: #0ea5e9;
            --hk-deep: #0c4a6e;
            --hk-bg: #f0f4f8;
            --hk-glass: rgba(255, 255, 255, 0.45);
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--hk-bg);
            color: #1e293b;
            letter-spacing: -0.01em;
            overflow-x: hidden;
            transition: background-color 0.3s ease;
        }

        /* 視差背景層 */
        .parallax-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 120%;
            pointer-events: none;
            z-index: -1;
            will-change: transform;
            transform: translateZ(0);
        }

        .bg-glow-1 {
            position: absolute;
            top: -10%;
            right: -15%;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(14, 165, 233, 0.2) 0%, transparent 70%);
            filter: blur(40px);
        }

        .bg-glow-2 {
            position: absolute;
            bottom: 20%;
            left: -10%;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(139, 92, 246, 0.15) 0%, transparent 70%);
            filter: blur(40px);
        }

        /* 深色模式 */
        @media (prefers-color-scheme: dark) {
            body { background-color: #0f172a; color: #f1f5f9; }
            .bg-glow-1 { background: radial-gradient(circle, rgba(14, 165, 233, 0.15) 0%, transparent 70%); }
            .bg-glow-2 { background: radial-gradient(circle, rgba(139, 92, 246, 0.1) 0%, transparent 70%); }
            .glass-card { background: rgba(30, 41, 59, 0.7) !important; border-color: rgba(255, 255, 255, 0.1) !important; }
            .text-slate-800 { color: #f1f5f9 !important; }
            .bg-white\/40 { background: rgba(15, 23, 42, 0.4) !important; }
            .bg-white\/50 { background: rgba(30, 41, 59, 0.5) !important; }
            input { color: #ffffff !important; }
        }

        .day-active {
            background: var(--hk-deep) !important; 
            color: #ffffff !important;
            transform: scale(1.05);
            box-shadow: 0 12px 24px -8px rgba(12, 74, 110, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
        }

        .day-active span, .day-active i { color: #ffffff !important; opacity: 1 !important; }

        /* 漸層遮罩 */
        .scroller-container { position: relative; }
        .scroller-mask-left {
            position: absolute; left: 0; top: 0; bottom: 0; width: 40px; z-index: 10;
            background: linear-gradient(to right, var(--hk-bg), transparent);
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        .scroller-mask-right {
            position: absolute; right: 0; top: 0; bottom: 0; width: 40px; z-index: 10;
            background: linear-gradient(to left, var(--hk-bg), transparent);
            pointer-events: none; transition: opacity 0.3s;
        }

        .glass-card {
            background: var(--hk-glass);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.04);
            transform: translateZ(0);
        }

        /* 導航欄固定樣式 - 取代原本的收縮動畫 */
        .sticky-nav-wrapper {
            position: sticky;
            top: 0;
            z-index: 50;
            padding: 8px 0;
            transition: all 0.3s ease;
        }
        
        /* 當導航欄「貼住」頂部時的微調 */
        .is-stuck {
            background: var(--hk-glass);
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 20px -5px rgba(0,0,0,0.05);
            padding: 12px 0;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .checked-item { opacity: 0.4; filter: grayscale(0.8); }

        .content-collapsed { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .content-expanded { max-height: 1000px; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        .animate-up { animation: slideUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .font-montserrat { font-family: 'Montserrat', sans-serif; }
    </style>
</head>
<body class="pb-36">

    <!-- 視差背景層 -->
    <div id="bg-layer-1" class="parallax-bg"><div class="bg-glow-1"></div></div>
    <div id="bg-layer-2" class="parallax-bg"><div class="bg-glow-2"></div></div>

    <!-- 頂部資訊區 (隨捲動自然消失) -->
    <header id="info-header" class="px-6 pt-10 pb-6 flex justify-between items-start transition-all duration-500 will-change-transform">
        <div>
            <div class="flex items-center space-x-2 mb-1">
                <i class="fas fa-mountain-sun text-sky-500 text-xs"></i>
                <h1 class="text-[10px] font-montserrat font-black text-sky-600 tracking-[0.4em] uppercase">Hokkaido</h1>
            </div>
            <div class="flex items-baseline space-x-1">
                <span class="text-3xl font-black text-slate-800">2025</span>
                <span class="text-xl font-light text-slate-300">/</span>
                <span class="text-2xl font-bold text-slate-800">Spring</span>
            </div>
        </div>
        <div class="glass-card rounded-2xl p-3 border border-white/60 text-right shadow-sm">
            <p class="text-[8px] font-black text-slate-400 uppercase tracking-widest flex items-center justify-end">
                <i class="fas fa-coins mr-1"></i> Budget
            </p>
            <div id="total-budget" class="text-lg font-black text-slate-800 leading-none mt-1">¥ 0</div>
            <div id="total-budget-twd" class="text-[9px] font-bold text-sky-600 mt-1 opacity-70">≈ NT$ 0</div>
        </div>
    </header>

    <!-- 原生 Sticky 導航條 (取代舊的收縮 Header) -->
    <div id="sticky-nav" class="sticky-nav-wrapper">
        <div class="glass-card mx-4 rounded-3xl overflow-hidden">
            <div class="scroller-container px-4 py-3">
                <div class="scroller-mask-left" id="mask-l"></div>
                <div class="scroller-mask-right" id="mask-r"></div>
                
                <div id="arrow-hint-l" class="absolute left-1 top-1/2 -translate-y-1/2 z-20 text-sky-500 opacity-0 transition-opacity duration-300 pointer-events-none">
                    <i class="fas fa-chevron-left text-[10px]"></i>
                </div>
                <div id="arrow-hint-r" class="absolute right-1 top-1/2 -translate-y-1/2 z-20 text-sky-500 opacity-0 transition-opacity duration-300 pointer-events-none">
                    <i class="fas fa-chevron-right text-[10px]"></i>
                </div>

                <div id="date-scroll-box" class="flex overflow-x-auto no-scrollbar py-1 space-x-2 items-center flex-nowrap scroll-smooth">
                    <button onclick="switchView('checklist')" id="btn-checklist" 
                        class="day-btn flex-shrink-0 w-11 h-11 rounded-xl bg-white/50 border border-white flex flex-col items-center justify-center transition-all duration-300 shadow-sm backdrop-blur-md">
                        <i class="fas fa-clipboard-check text-slate-400 text-base"></i>
                    </button>
                    <div id="day-buttons-container" class="flex flex-nowrap space-x-2"></div>
                </div>
            </div>
            <!-- Progress -->
            <div class="w-full bg-slate-200/30 h-[2.5px]">
                <div id="progress-bar" class="bg-sky-600 h-full transition-all duration-1000 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- 主要內容區 -->
    <main id="content-area" class="px-6 py-6 max-w-lg mx-auto space-y-10"></main>

    <!-- 底部導航 -->
    <nav class="fixed bottom-6 left-6 right-6 z-50">
        <div class="glass-card rounded-[32px] p-4 flex justify-between items-center shadow-2xl">
            <div class="pl-2">
                <p id="bottom-label" class="text-[8px] font-black text-slate-400 uppercase tracking-widest">Today's Cost</p>
                <p id="bottom-value" class="text-xl font-black text-slate-800 leading-tight">¥ 0</p>
                <p id="bottom-value-twd" class="text-[9px] font-bold text-sky-600 opacity-70 leading-none">≈ NT$ 0</p>
            </div>
            <div class="flex space-x-2">
                <button onclick="window.scrollTo({top:0, behavior:'smooth'})" class="w-12 h-12 flex items-center justify-center text-slate-400 hover:text-sky-500 transition-colors">
                    <i class="fas fa-circle-chevron-up text-xl"></i>
                </button>
                <button onclick="shareItinerary()" class="bg-slate-900 dark:bg-slate-100 text-white dark:text-slate-900 px-8 h-12 rounded-[20px] text-[10px] font-black tracking-[0.2em] uppercase shadow-lg active:scale-95 transition-all">
                    Share
                </button>
            </div>
        </div>
    </nav>

    <script>
        const JPY_TO_TWD = 0.21;

        const getWeatherIcon = (desc) => {
            if (desc.includes("晴れ") || desc.includes("快晴")) return "fa-sun text-amber-500";
            if (desc.includes("曇り")) return "fa-cloud text-slate-400";
            if (desc.includes("雪")) return "fa-snowflake text-sky-300";
            if (desc.includes("雨")) return "fa-cloud-showers-heavy text-indigo-500";
            return "fa-cloud-sun text-amber-400";
        };

        const itinerary = [
            { date: "3/26", day: "Day 01", weather_jp: "曇り", temp: "2°C / 8°C", haiku: "春の雲 旅の始まり 札幌へ", hotel: "札幌全日空薄野假日酒店", transport: "JR 快速 + 地鐵南北線", activities: [{ title: "新千歲機場抵達", desc: "抵達北海道門戶，建議先到國內線航廈，感受豐富的伴手禮與Royce巧克力工廠美食。" }, { title: "飯店存放行李", desc: "抵達薄野核心區域，安頓後準備展開札幌市區的探索旅程。" }, { title: "狸小路 1-7 丁目散策", desc: "橫跨七個街區的百年商店街，藥妝、餐廳、伴手禮店林立，充滿在地活力。" }], lunch: "根室花丸壽司", dinner: "GARAKU 湯咖哩" },
            { date: "3/27", day: "Day 02", weather_jp: "晴れ", temp: "3°C / 10°C", haiku: "学び舎に 春の陽射しや 北大路", hotel: "札幌全日空薄野假日酒店", transport: "地鐵南北線/東豐線", activities: [{ title: "北海道大學漫步", desc: "感受日本最美校園，漫步銀杏大道與歷史悠久的歐風建築群。" }, { title: "諏訪神社參拜", desc: "著名的「花手水」神社，洗手池中鋪滿季節花卉，是拍照與祈好運熱點。" }, { title: "札幌啤酒博物館", desc: "了解日本啤酒開拓史，並可以在結束後試喝最新鮮的開拓使啤酒。" }], lunch: "北大中央食堂", dinner: "札幌啤酒園燒肉" },
            { date: "3/28", day: "Day 03", weather_jp: "曇り時々晴れ", temp: "4°C / 9°C", haiku: "祈り捧ぐ 響くメロディ 春の宵", hotel: "札幌全日空薄野假日酒店", transport: "地鐵東西線 + 東豐線", activities: [{ title: "北海道神宮", desc: "北海道最大的守護神殿，被圓山原始林環繞，氣氛肅穆寧靜。" }, { title: "圓山公園", desc: "當地人最愛的休憩場地，享受初春清新的空氣與森林芬多精。" }, { title: "Vaundy 演唱會", desc: "旅程的核心時刻！在震憾的音場中感受 Vaundy 獨特的音樂世界。" }], lunch: "炸豬排 玉藤", dinner: "串鳥居酒屋" },
            { date: "3/29", day: "Day 04", weather_jp: "雪", temp: "0°C / 5°C", haiku: "小樽路や 運河に舞いし 春の雪", hotel: "札幌全日空薄野假日酒店", transport: "JR 快速 (往返)", activities: [{ title: "小樽甜點街", desc: "漫步堺町通，六花亭、北菓樓名店林立，是購買精緻甜食的首選。" }, { title: "籔半蕎麥麵", desc: "在充滿歷史情懷的石磨麵屋中，品嚐手工蕎麥麵的獨特香氣。" }, { title: "山中牧場冰淇淋", desc: "牧場直送的極致美味！純粹無添加的奶香是小樽必嚐療癒甜點。" }, { title: "小樽運河夜景", desc: "石造倉庫群與瓦斯燈倒映在靜謐的水面，呈現極致的浪漫懷舊感。" }], lunch: "蕎麥屋 籔半", dinner: "寶壽司" },
            { date: "3/30", day: "Day 05", weather_jp: "曇り", temp: "1°C / 7°C", haiku: "湯の煙 地獄の谷に 春霞", hotel: "登別第一瀧本館", transport: "JR 特急北斗號 + 巴士", activities: [{ title: "移動至登別", desc: "搭乘特急前往著名的溫泉之鄉。登別以多樣泉質聞名，是放鬆身心的絕佳站。" }, { title: "尼克斯海洋公園", desc: "融合北歐建築風格的水族館，最受歡迎的是可愛的企鵝遊行。" }, { title: "第一瀧本館溫泉", desc: "擁有24小時超大浴場，可一邊泡湯一邊眺望地獄谷壯闊風景。" }], lunch: "自理", dinner: "飯店豪華晚宴" },
            { date: "3/31", day: "Day 06", weather_jp: "快晴", temp: "4°C / 11°C", haiku: "青い空 旅路を照らす 春の風", hotel: "札幌全日空皇冠假日酒店", transport: "JR 特急北斗號", activities: [{ title: "登別溫泉街散策", desc: "逛逛商店街，尋找隱藏在遍布各處的鬼怪石像，感受地獄谷氣息。" }, { title: "返回札幌市區", desc: "帶著溫泉後的舒爽心情返回市中心，入住靠近車站的飯店。" }, { title: "自由採買時間", desc: "前往札幌車站周邊大型百貨與地下街，享受採購與生活樂趣。" }], lunch: "溫泉街小吃", dinner: "拉麵信玄" },
            { date: "4/01", day: "Day 07", weather_jp: "雨", temp: "5°C / 9°C", haiku: "雨の午後 チョコの香りに 春を知る", hotel: "札幌全日空皇冠假日酒店", transport: "地鐵 + 直達巴士", activities: [{ title: "白色戀人公園", desc: "夢幻的巧克力工廠，除了伴手禮，也能享用限定甜點。" }, { title: "三井 Outlet Park 北廣島", desc: "精選品牌包括：UNITED ARROWS LTD.、BEAMS、URBAN RESEARCH warehouse、LOWRYS FARM、GLOBAL WORK，更有 THE NORTH FACE、New Balance 及 ASICS 等運動戶外名店。", extraLink: { label: "Floor Map (PDF)", url: "https://mitsui-shopping-park.com/mop/file/filter/sapporo/floor/00009_fo.pdf", icon: "fa-map-location-dot" } }], lunch: "Outlet 美食街", dinner: "迴轉壽司 Toriton" },
            { date: "4/02", day: "Day 08", weather_jp: "晴れ", temp: "6°C / 13°C", haiku: "旅終わり 空港に吹く 春一番", hotel: "無 (回程)", transport: "JR 快速 Airport 號", activities: [{ title: "空港最後掃貨", desc: "新千歲空港國內線航廈是購物天堂，請留足時間買齊清單。" }, { title: "賦歸回台", desc: "帶著滿載的行李與充實的回憶，前往國際線登機，為這段旅程畫下完美點。" }], lunch: "豚丼信玄 (機場店)", dinner: "機上餐食" }
        ];

        const checklistData = [
            { category: "重要文件", items: ["護照正本", "日幣現金 / 信用卡", "保險文件", "Vaundy 門票", "Visit Japan Web"] },
            { category: "電子產品", items: ["行動電源", "各項充電線", "SIM 卡 / WiFi", "相機"] },
            { category: "必備衣物", items: ["防風防水外套", "發熱衣褲", "手套圍巾", "防滑鞋", "備用襪"] },
            { category: "個人用品", items: ["常備藥品", "保濕保養", "雨具", "購物袋"] }
        ];

        let currentView = 'day';
        let currentDayIdx = 0;
        let expandedActivityIdx = null; 
        let lastKnownScrollPosition = 0;
        let ticking = false;

        let storage = {
            completed: JSON.parse(localStorage.getItem('hokkaido_tasks') || '{}'),
            budget: JSON.parse(localStorage.getItem('hokkaido_budget') || '{}'),
            checklist: JSON.parse(localStorage.getItem('hokkaido_checklist_status') || '{}')
        };

        function init() {
            detectCurrentDay();
            renderDayButtons();
            renderContent();
            calculateGlobalStats();
            setupScrollerEvents();
            setupSimplifiedScroll();
        }

        function detectCurrentDay() {
            const now = new Date();
            const month = now.getMonth() + 1;
            const date = now.getDate();
            const datesMap = { "3-26": 0, "3-27": 1, "3-28": 2, "3-29": 3, "3-30": 4, "3-31": 5, "4-1": 6, "4-2": 7 };
            const key = `${month}-${date}`;
            if (datesMap.hasOwnProperty(key)) currentDayIdx = datesMap[key];
        }

        function setupScrollerEvents() {
            const scroller = document.getElementById('date-scroll-box');
            const maskL = document.getElementById('mask-l');
            const maskR = document.getElementById('mask-r');
            const hintL = document.getElementById('arrow-hint-l');
            const hintR = document.getElementById('arrow-hint-r');

            const updateMasks = () => {
                const scrollLeft = scroller.scrollLeft;
                const maxScroll = scroller.scrollWidth - scroller.clientWidth;
                const showL = scrollLeft > 10;
                const showR = scrollLeft < maxScroll - 10;
                maskL.style.opacity = showL ? "1" : "0";
                maskR.style.opacity = showR ? "1" : "0";
                if (hintL) hintL.style.opacity = showL ? "1" : "0";
                if (hintR) hintR.style.opacity = showR ? "1" : "0";
            };

            scroller.addEventListener('scroll', updateMasks, { passive: true });
            setTimeout(() => {
                const activeBtn = document.getElementById(`btn-day-${currentDayIdx}`);
                if (activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
                updateMasks();
            }, 500);
        }

        function setupSimplifiedScroll() {
            const infoHeader = document.getElementById('info-header');
            const stickyNav = document.getElementById('sticky-nav');
            const bg1 = document.getElementById('bg-layer-1');
            const bg2 = document.getElementById('bg-layer-2');

            window.addEventListener('scroll', () => {
                lastKnownScrollPosition = window.scrollY;

                if (!ticking) {
                    window.requestAnimationFrame(() => {
                        // 1. 資訊區淡化位移 (GPU加速，不影響佈局)
                        const fadeVal = Math.max(0, 1 - lastKnownScrollPosition / 100);
                        const transVal = lastKnownScrollPosition * 0.4;
                        infoHeader.style.opacity = fadeVal;
                        infoHeader.style.transform = `translate3d(0, -${transVal}px, 0)`;

                        // 2. 背景視差
                        bg1.style.transform = `translate3d(0, ${lastKnownScrollPosition * 0.3}px, 0)`;
                        bg2.style.transform = `translate3d(0, ${lastKnownScrollPosition * 0.2}px, 0)`;

                        // 3. 粘性導航狀態標記 (僅用於微調樣式)
                        if (lastKnownScrollPosition > 50) {
                            stickyNav.classList.add('is-stuck');
                        } else {
                            stickyNav.classList.remove('is-stuck');
                        }

                        ticking = false;
                    });
                    ticking = true;
                }
            }, { passive: true });
        }

        function renderDayButtons() {
            const container = document.getElementById('day-buttons-container');
            container.innerHTML = itinerary.map((d, i) => `
                <button onclick="switchView('day', ${i})" id="btn-day-${i}" 
                    class="day-btn flex-shrink-0 w-11 h-11 rounded-xl bg-white/40 border border-white flex flex-col items-center justify-center transition-all duration-300 shadow-sm backdrop-blur-md">
                    <span class="text-[7px] font-black text-slate-400 uppercase tracking-tighter">${d.day.split(' ')[1]}</span>
                    <span class="text-xs font-black text-slate-800 leading-none">${d.date.split('/')[1]}</span>
                </button>
            `).join('');
            updateActiveState();
        }

        function switchView(view, idx = 0) {
            currentView = view;
            if (view === 'day') {
                currentDayIdx = idx;
                expandedActivityIdx = null; 
            }
            updateActiveState();
            renderContent();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function updateActiveState() {
            document.querySelectorAll('.day-btn').forEach(btn => btn.classList.remove('day-active'));
            if (currentView === 'checklist') {
                document.getElementById('btn-checklist').classList.add('day-active');
            } else if (document.getElementById(`btn-day-${currentDayIdx}`)) {
                document.getElementById(`btn-day-${currentDayIdx}`).classList.add('day-active');
            }
        }

        function renderContent() {
            if (currentView === 'checklist') renderChecklist();
            else renderDay();
        }

        function toggleActivity(idx) {
            expandedActivityIdx = expandedActivityIdx === idx ? null : idx;
            renderDay();
        }

        function toggleTask(e, taskIdx) {
            e.stopPropagation(); 
            const key = `d${currentDayIdx}-t${taskIdx}`;
            storage.completed[key] = !storage.completed[key];
            localStorage.setItem('hokkaido_tasks', JSON.stringify(storage.completed));
            renderDay();
            calculateGlobalStats();
        }

        function renderDay() {
            const d = itinerary[currentDayIdx];
            const content = document.getElementById('content-area');
            const dailyBudget = storage.budget[currentDayIdx] || 0;
            const budgetTwd = Math.round(dailyBudget * JPY_TO_TWD);

            document.getElementById('bottom-label').innerText = "Today's Cost";
            document.getElementById('bottom-value').innerText = `¥ ${dailyBudget.toLocaleString()}`;
            document.getElementById('bottom-value-twd').innerText = `≈ NT$ ${budgetTwd.toLocaleString()}`;

            content.innerHTML = `
                <div class="animate-up">
                    <div class="glass-card rounded-[32px] p-8 mb-8 relative overflow-hidden">
                        <div class="absolute -right-12 -top-12 w-48 h-48 bg-sky-400/10 rounded-full blur-[80px]"></div>
                        <div class="relative z-10 flex items-center justify-between">
                            <div class="flex-1">
                                <p class="text-[8px] font-black text-sky-600 uppercase tracking-[0.3em] mb-3">Weather Focus</p>
                                <div class="flex items-center space-x-3 mb-6">
                                    <i class="fas ${getWeatherIcon(d.weather_jp)} text-3xl"></i>
                                    <div>
                                        <h2 class="text-2xl font-black text-slate-800 tracking-tight">${d.weather_jp}</h2>
                                        <p class="text-xs font-bold text-slate-400 tracking-wider">${d.temp}</p>
                                    </div>
                                </div>
                                <div class="flex items-start space-x-3">
                                    <i class="fas fa-feather text-sky-300 text-[10px] mt-1"></i>
                                    <p class="text-slate-500 font-medium text-xs italic leading-relaxed opacity-90">${d.haiku}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <section class="mb-10">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-6 pl-2 flex items-center">
                            <i class="fas fa-list-ul mr-2 text-sky-500 text-[10px]"></i> Itinerary
                        </h3>
                        <div class="space-y-4">
                            ${d.activities.map((act, i) => {
                                const isChecked = storage.completed[`d${currentDayIdx}-t${i}`];
                                const isExpanded = expandedActivityIdx === i;
                                return `
                                    <div class="glass-card rounded-[28px] overflow-hidden transition-all duration-500 ${isExpanded ? 'ring-1 ring-sky-500/30 shadow-lg' : ''} ${isChecked ? 'checked-item' : ''}">
                                        <div onclick="toggleActivity(${i})" class="p-6 flex items-center cursor-pointer active:bg-white/50">
                                            <div onclick="toggleTask(event, ${i})" class="w-6 h-6 rounded-full border-2 ${isChecked ? 'bg-slate-800 border-slate-800 dark:bg-slate-100 dark:border-slate-100 shadow-lg' : 'border-white'} flex items-center justify-center mr-4 transition-all">
                                                ${isChecked ? '<i class="fas fa-check text-white dark:text-slate-900 text-[9px]"></i>' : ''}
                                            </div>
                                            <span class="flex-1 text-sm font-bold text-slate-800 tracking-tight">${act.title}</span>
                                            <i class="fas ${isExpanded ? 'fa-minus' : 'fa-plus'} text-[9px] text-slate-300 transition-all"></i>
                                        </div>
                                        <div class="${isExpanded ? 'content-expanded' : 'content-collapsed'}">
                                            <div class="px-6 pb-6">
                                                <div class="p-5 bg-white/30 backdrop-blur-md rounded-2xl border border-white/40 shadow-inner">
                                                    <p class="text-xs text-slate-500 leading-relaxed mb-5 font-medium">${act.desc}</p>
                                                    <div class="space-y-2">
                                                        ${act.extraLink ? `<button onclick="window.open('${act.extraLink.url}', '_blank')" class="w-full bg-slate-900 text-white dark:bg-slate-100 dark:text-slate-900 py-3 rounded-xl text-[9px] font-black tracking-widest uppercase border border-white flex items-center justify-center shadow-lg active:scale-95 transition-all"><i class="fas ${act.extraLink.icon} mr-2"></i> ${act.extraLink.label}</button>` : ''}
                                                        <button onclick="openMap('${act.title}')" class="w-full bg-white/60 backdrop-blur-sm text-slate-800 py-3 rounded-xl text-[9px] font-black tracking-widest uppercase border border-white flex items-center justify-center shadow-sm active:scale-95 transition-all"><i class="fas fa-location-arrow mr-2 text-sky-600"></i> View on Map</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </section>

                    <div class="grid grid-cols-2 gap-4 mb-10">
                        <div class="glass-card p-6 rounded-[32px] flex flex-col items-center text-center">
                            <i class="fas fa-hotel text-sky-500 mb-3 text-sm"></i>
                            <p class="text-[7px] text-slate-400 font-black uppercase tracking-widest mb-1">Accommodation</p>
                            <p class="text-[10px] font-bold text-slate-800 leading-tight">${d.hotel}</p>
                        </div>
                        <div class="glass-card p-6 rounded-[32px] flex flex-col items-center text-center">
                            <i class="fas fa-train-subway text-indigo-500 mb-3 text-sm"></i>
                            <p class="text-[7px] text-slate-400 font-black uppercase tracking-widest mb-1">Transit</p>
                            <p class="text-[10px] font-bold text-slate-800 leading-tight">${d.transport}</p>
                        </div>
                    </div>

                    <section class="glass-card rounded-[32px] p-8 mb-10">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.3em] mb-6 flex items-center">
                            <i class="fas fa-utensils mr-2 text-rose-400 text-[10px]"></i> Dining
                        </h3>
                        <div class="space-y-3">
                            <div onclick="openMap('${d.lunch}')" class="flex items-center justify-between p-4 bg-white/30 rounded-2xl cursor-pointer hover:bg-white/50 transition-all border border-white/50">
                                <span class="text-[8px] font-black text-sky-600 uppercase tracking-widest">Lunch</span>
                                <span class="text-xs font-bold text-slate-800">${d.lunch} <i class="fas fa-arrow-right-long ml-2 text-[8px] opacity-30"></i></span>
                            </div>
                            <div onclick="openMap('${d.dinner}')" class="flex items-center justify-between p-4 bg-white/30 rounded-2xl cursor-pointer hover:bg-white/50 transition-all border border-white/50">
                                <span class="text-[8px] font-black text-sky-600 uppercase tracking-widest">Dinner</span>
                                <span class="text-xs font-bold text-slate-800">${d.dinner} <i class="fas fa-arrow-right-long ml-2 text-[8px] opacity-30"></i></span>
                            </div>
                        </div>
                    </section>

                    <section class="glass-card rounded-[32px] p-8 mb-12 border-none bg-white/50">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xs font-black uppercase tracking-widest text-slate-400">Expense Logger</h3>
                            <i class="fas fa-wallet text-slate-300"></i>
                        </div>
                        <div class="relative">
                            <span class="absolute left-0 top-1/2 -translate-y-1/2 text-2xl font-light text-slate-300 font-montserrat italic">¥</span>
                            <input type="number" value="${dailyBudget || ""}" oninput="updateBudget(this.value)" 
                                placeholder="0" 
                                class="w-full bg-transparent border-b border-slate-200/50 py-4 pl-8 text-4xl font-montserrat font-black text-slate-800 focus:border-sky-500 outline-none transition-all placeholder:text-slate-100">
                        </div>
                        <p class="text-[10px] text-sky-600 mt-4 font-bold opacity-60">≈ NT$ ${budgetTwd.toLocaleString()}</p>
                    </section>
                </div>
            `;
        }

        function renderChecklist() {
            const content = document.getElementById('content-area');
            document.getElementById('bottom-label').innerText = "Overall Status";
            let total = 0, done = 0;
            checklistData.forEach((cat, cIdx) => {
                cat.items.forEach((_, iIdx) => {
                    total++;
                    if(storage.checklist[`c${cIdx}-i${iIdx}`]) done++;
                });
            });
            const progress = Math.round((done / total) * 100);
            document.getElementById('bottom-value').innerText = `${progress}% Prepared`;
            document.getElementById('bottom-value-twd').innerText = "";

            content.innerHTML = `
                <div class="animate-up">
                    <div class="mb-12 text-center">
                        <i class="fas fa-suitcase-rolling text-sky-500 text-3xl mb-4"></i>
                        <p class="text-sky-600 font-black text-[10px] tracking-[0.4em] uppercase mb-1">Checklist</p>
                        <h2 class="text-4xl font-black text-slate-800 tracking-tight">行前清單</h2>
                    </div>
                    ${checklistData.map((cat, cIdx) => `
                        <section class="mb-10">
                            <h3 class="text-slate-400 font-black text-xs uppercase tracking-widest mb-6 border-l-2 border-sky-400 pl-4">${cat.category}</h3>
                            <div class="grid grid-cols-1 gap-3">
                                ${cat.items.map((item, iIdx) => {
                                    const isChecked = storage.checklist[`c${cIdx}-i${iIdx}`];
                                    return `
                                        <div onclick="toggleChecklist(${cIdx}, ${iIdx})" class="glass-card p-5 rounded-[24px] flex items-center cursor-pointer active:scale-[0.98] transition-all">
                                            <div class="w-6 h-6 rounded-full border-2 ${isChecked ? 'bg-slate-800 border-slate-800 dark:bg-slate-100 dark:border-slate-100 shadow-lg' : 'border-white'} flex items-center justify-center mr-4 transition-all">
                                                ${isChecked ? '<i class="fas fa-check text-white dark:text-slate-900 text-[9px]"></i>' : ''}
                                            </div>
                                            <span class="text-sm font-bold ${isChecked ? 'checked-item' : 'text-slate-700'}">${item}</span>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </section>
                    `).join('')}
                </div>
            `;
        }

        function toggleChecklist(catIdx, itemIdx) {
            const key = `c${catIdx}-i${itemIdx}`;
            storage.checklist[key] = !storage.checklist[key];
            localStorage.setItem('hokkaido_checklist_status', JSON.stringify(storage.checklist));
            renderChecklist();
        }

        function updateBudget(val) {
            storage.budget[currentDayIdx] = parseInt(val) || 0;
            localStorage.setItem('hokkaido_budget', JSON.stringify(storage.budget));
            calculateGlobalStats();
            renderDay(); 
        }

        function calculateGlobalStats() {
            let totalTasks = 0, doneTasks = 0;
            itinerary.forEach((d, dIdx) => {
                d.activities.forEach((_, tIdx) => {
                    totalTasks++;
                    if(storage.completed[`d${dIdx}-t${tIdx}`]) doneTasks++;
                });
            });
            const progress = (doneTasks / totalTasks) * 100;
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) progressBar.style.width = `${progress}%`;
            
            let totalSpend = 0;
            Object.values(storage.budget).forEach(v => totalSpend += v);
            const totalBudgetElem = document.getElementById('total-budget');
            if (totalBudgetElem) totalBudgetElem.innerText = `¥ ${totalSpend.toLocaleString()}`;

            const totalBudgetTwdElem = document.getElementById('total-budget-twd');
            if (totalBudgetTwdElem) {
                const totalTwd = Math.round(totalSpend * JPY_TO_TWD);
                totalBudgetTwdElem.innerText = `≈ NT$ ${totalTwd.toLocaleString()}`;
            }
        }

        function openMap(query) { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`, '_blank'); }
        function shareItinerary() { alert("已為您產生行程清單連結，隨時可與同行好友分享！"); }

        init();
    </script>
</body>
</html>
